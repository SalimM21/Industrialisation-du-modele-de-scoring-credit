# ---------------------------------------------
# Variables
# ---------------------------------------------
DOCKER_IMAGE = credit-scoring-api:latest
MODEL_PATH   = models/latest_model.pkl
MLFLOW_URI   = http://localhost:5000

# ---------------------------------------------
# Commandes par dÃ©faut
# ---------------------------------------------
.PHONY: all
all: build test

# ---------------------------------------------
# 1. Installation dÃ©pendances
# ---------------------------------------------
.PHONY: install
install:
	@echo "ðŸ’  Installation des dÃ©pendances..."
	pip install --upgrade pip
	pip install -r requirements.txt

# ---------------------------------------------
# 2. Build Docker
# ---------------------------------------------
.PHONY: build
build:
	@echo "ðŸ’  Build de l'image Docker..."
	docker build -t $(DOCKER_IMAGE) .

# ---------------------------------------------
# 3. Tests unitaires
# ---------------------------------------------
.PHONY: test
test:
	@echo "ðŸ’  Lancement des tests unitaires..."
	pytest -v tests/

# ---------------------------------------------
# 4. Export du modÃ¨le
# ---------------------------------------------
.PHONY: export_model
export_model:
	@echo "ðŸ’  Export du modÃ¨le..."
	python src/export_model.py

# ---------------------------------------------
# 5. Enregistrement MLflow
# ---------------------------------------------
.PHONY: register_mlflow
register_mlflow:
	@echo "ðŸ’  Enregistrement du modÃ¨le dans MLflow..."
	python src/register_mlflow.py --model-path $(MODEL_PATH) --mlflow-uri $(MLFLOW_URI)

# ---------------------------------------------
# 6. Lancement API
# ---------------------------------------------
.PHONY: run_api
run_api:
	@echo "ðŸ’  DÃ©marrage de l'API FastAPI..."
	uvicorn src.main:app --reload --host 0.0.0.0 --port 8000

# ---------------------------------------------
# 7. Lancement monitoring/dashboards
# ---------------------------------------------
.PHONY: monitor
monitor:
	@echo "ðŸ’  GÃ©nÃ©ration du dashboard Evidently..."
	python src/generate_report.py

# ---------------------------------------------
# 8. DÃ©ploiement Docker (serveur local)
# ---------------------------------------------
.PHONY: deploy
deploy:
	@echo "ðŸ’  DÃ©ploiement de l'image Docker..."
	docker stop credit_scoring || true
	docker rm credit_scoring || true
	docker run -d --name credit_scoring -p 8000:8000 $(DOCKER_IMAGE)

# ---------------------------------------------
# 9. Nettoyage
# ---------------------------------------------
.PHONY: clean
clean:
	@echo "ðŸ’  Nettoyage des fichiers temporaires..."
	rm -rf __pycache__ .pytest_cache logs dashboards/*.html models/*.pkl
